create or replace view v_edificio_mansione as
select x.edificio || '-' || x.mansioni as codice,
       x.edificio,
     --  x.descrizione,
        x.mansioni,
      sum( x.carico) carico
  from (
         select distinct edi.oid as edificio,
                        --imp.descrizione,
                imp.oid as Impianto,        
                a.oid as Apparato,
                sk.mansioniopt as mansioni,
                ask.schedamp,
               -- f.descrizione,f.cadenze_anno,
/*                 (a.quantita * sk.tempoopt * sk.numman *
                              f.cadenze_anno)  carico1,
                (1 +
                 ((Nvl(ku.valore, 1) - 1) + (Nvl(a.kguasto, 1) - 1) +
                 (Nvl(kd.valore, 1) - 1) + (Nvl(kc.valore, 1) - 1) +
                 (Nvl(kb.valore, 1) - 1) \*+ Nvl(c.presidio, 0)*\
                 )) carico2,*/
                (a.quantita * sk.tempoopt * sk.numman * f.cadenze_anno) *
                (1 +
                 ((Nvl(ku.valore, 1) - 1) + (Nvl(a.kguasto, 1) - 1) +
                 (Nvl(kd.valore, 1) - 1) + (Nvl(kc.valore, 1) - 1) +
                 (Nvl(kb.valore, 1) - 1) /*+ Nvl(c.presidio, 0)*/
                 )) carico
  from edificio         edi,
       impianto         imp,
       apparato         a,
       APPARATOSCHEDAMP ask,
       schedemp         sk,
       frequenze        f,
       kdimensione kd,
       kutenza  ku,
       kcondizione kc,
       kubicazione kb
       
 where edi.oid = imp.edificio
 and   imp.oid = a.impianto
   and a.oid = ask.apparato
   and ask.schedamp = sk.oid
   and sk.frequenzaopt = f.oid
   and sk.kdimensione= kd.oid (+)
   and sk.kcondizione= kc.oid (+)
   and sk.kutenza= ku.oid (+)
  and  sk.kubicazione = kb.oid (+)
   and sk.mansioniopt is not null
   --and imp.oid = 206

        ) x
 --where x.impianto = 206
 group by x.edificio,  x.mansioni--,--x.descrizione
 order by edificio, carico
;
