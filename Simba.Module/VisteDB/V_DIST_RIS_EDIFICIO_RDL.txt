
create or replace view V_DIST_RIS_EDIFICIO_RDL as 
--da la distanza di tutte le risorseteam dall'impianto dell'rdl relativo alle notifiche emergenze inserite
select distinct to_number(NOTIFICHEEMERGENZEREG||RISORSETEAM||EDIFICIO||IMPIANTO) codice, NOTIFICHEEMERGENZEREG ,RISORSETEAM,RISORSACAPO,EDIFICIO,IMPIANTO,INDIRIZZO ,acos(round(sin(round(longitudine_edificio,5)) * sin(round(longitudine_risorsa,5)) + Cos(round(longitudine_edificio,5)) 
       *cos(round(longitudine_risorsa,5)) * cos(round(latitudine_risorsa,5) - round(latitudine_edificio,5)),5)) * 6371 DIST
  from  (select nvl(i.geolat,41.904321) latitudine_edificio, nvl(i.geolng,12.491455)  longitudine_edificio,
                nvl(r.geolat,41.904321) latitudine_risorsa, nvl(r.geolng ,12.491455)  longitudine_risorsa, 
                t.Oid RISORSETEAM,e.oid EDIFICIO, im.oid IMPIANTO, i.oid INDIRIZZO, ner.oid NOTIFICHEEMERGENZEREG,risorsacapo RISORSACAPO
           from impianto im, edificio e , indirizzo i, 
                risorse r,risorseteam t,
                rdl rdl, notificheemergenzereg ner
          where im.edificio=e.oid 
            and e.indirizzo=i.oid
            and r.oid=t.risorsacapo
            and rdl.impianto = im.oid
            and rdl.oid = ner.rdl
            -- esclude le notificheemergenze chiuse
            and ner.datachiusura is  null
            --and rdl.statooperativo =19 --da prendere in carico
            ) vv
            --elimino dalla lista le risorse che hanno gia assegnate delle notifiche emergenze per quelle emergenze
            where not exists (select anot.risorseteam
                                from NOTIFICHEEMERGENZE anot
                               where anot.notificheemergenzereg = vv.NOTIFICHEEMERGENZEREG
                                 and anot.risorseteam = vv.risorseteam
                                 ) ;